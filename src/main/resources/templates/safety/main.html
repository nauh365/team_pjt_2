<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <title>안전한 자전거 길 안내</title>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=kp0utn2vxk"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>
<body class="p-3">
<div id="map" style="width:75%;height: 50vh;" class="mb-3"></div>
<div class="mb-3 w-50">
  <div class="mb-3">
    <label for="search-input" class="form-label">현재 위치를 지번, 도로명로 입력해주세요.(예. 분당구)</label>
    <input id="search-input" class="form-control" type="text">
  </div>
  <button id="find-route-to-address-btn" class="btn btn-primary" type="button">현재 위치로</button>
</div>
<div class="w-50">
  <div class="mb-3">
    <label for="start-ip-input" class="form-label">시작 IP</label>
    <input id="start-ip-input" class="form-control" type="text">
  </div>
  <div class="mb-3">
    <label for="goal-ip-input" class="form-label">도착 IP</label>
    <input id="goal-ip-input" class="form-control" type="text">
  </div>
  <button id="find-route-ip-btn" class="btn btn-primary" type="button">경로 구하기</button>
</div>
<script>
    let position = new naver.maps.LatLng(37.3595704, 127.105399)
    let mapOptions = {
        center: position,
        zoom: 15,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    };

    let map = new naver.maps.Map('map', mapOptions);
    let polyline = null;
    let markers = [];

    naver.maps.Event.addListener(map, 'click', function(e) {
        if (polyline !== null) polyline.setMap(null)
        // marker.setPosition(e.coord);
        if (markers.length === 2) {
            markers.forEach(marker => {
                marker.setMap(null)
            })
            markers.length = 0
        }

        else {
            markers.push(new naver.maps.Marker({
                position: e.coord,
                map: map
            }))
        }
    });

    const drawRoute = (resultPath) => {
        if (polyline !== null) polyline.setMap(null)
        const path = []
        resultPath.forEach(point => {
            path.push(new naver.maps.LatLng(point.lat, point.lng))
        })

        polyline = new naver.maps.Polyline({
            map: map,
            path: path
        })
    }

    const queryInput = document.getElementById('search-input');
    document.getElementById('find-route-to-address-btn').addEventListener('click', () => {
        const query = queryInput.value;
        if (query.length === 0) {
            alert('검색어를 입력하세요');
            return;
        }
        const lat = map.getCenter().lat();
        const lng = map.getCenter().lng();
        // 사용자가 입력한 주소에 대한 좌표를 받아오기 위한 fetch 요청
        fetch('/safety-direction/check', {
            method: 'post',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                query
            })
        }).then(async response => {
            console.log(response)
            if (response.ok) {
                const data = await response.json(); // 응답에서 데이터 추출
                const {lat, lng, bjDongCode} = data; // 법정동 코드 추가
                // const {lat, lng} = await response.json(); // 응답에서 위도와 경도 추출
                // 지도의 중심을 사용자가 입력한 주소의 좌표로 이동
                map.setCenter({lat, lng});
                alert(`${query} 위치로 이동되었습니다.`);
                // 콘솔에 법정동 코드 출력(확인 완)
                console.log(`법정동 코드: ${bjDongCode}`);
            } else {
                // 응답이 성공적이지 않은 경우, 오류 메시지 출력
                alert('주소를 찾을 수 없습니다.');
            }
        });
    });

    const startIpInput = document.getElementById('start-ip-input')
    const goalIpInput = document.getElementById('goal-ip-input')
    document.getElementById('find-route-ip-btn').addEventListener('click', () => {
        const startIp = startIpInput.value
        const goalIp = goalIpInput.value
        fetch('/navigate/ips', {
            method: 'post',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({ startIp, goalIp })
        }).then(async response => {
            console.log(response)
            if (response.ok) {
                drawRoute((await response.json()).path)
                alert(`${startIp} -> ${goalIp}`)
            }
        })

    })

    // 받아온 데이터의 위도, 경도를 지도에 표시
    // const accidentData = [[${accidents}]]; // Controller에서 전달된 사고다발 지역 데이터
    // const lotData = [[${lot}]];
    // const latData = [[${lat}]];
    //
    // accidentData.forEach(function(accident) {
    //     // 데이터 형식에 따라 경도, 위도 정보를 추출해야 합니다.
    //     // 여기서는 accident 변수가 경도와 위도 정보를 포함하고 있다고 가정합니다.
    //     var marker = new naver.maps.Marker({
    //         position: new naver.maps.LatLng(accident.latitude, accident.longitude),
    //         map: map
    //     });
    // });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>