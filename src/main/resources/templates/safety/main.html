<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <title>안전한 자전거 길 안내</title>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=kp0utn2vxk"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>
<body class="p-3">
<div id="map" style="width:75%;height: 50vh;" class="mb-3"></div>
<div class="mb-3 w-50">
  <div class="mb-3">
    <label for="search-input" class="form-label">현재 위치를 지번, 도로명로 입력해주세요.(예. 분당구)</label>
    <input id="search-input" class="form-control" type="text">
  </div>
  <button id="find-route-to-address-btn" class="btn btn-primary" type="button">현재 위치로</button>
</div>

<script>
    let position = new naver.maps.LatLng(37.3595704, 127.105399)
    let mapOptions = {
        center: position,
        zoom: 15,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    };

    let map = new naver.maps.Map('map', mapOptions);
    let markers = [];

    // 마커를 사용할 수 있도록 수정

    const queryInput = document.getElementById('search-input');
    document.getElementById('find-route-to-address-btn').addEventListener('click', () => {
        const query = queryInput.value;
        if (query.length === 0) {
            alert('검색어를 입력하세요');
            return;
        }
        // 사용자가 입력한 주소에 대한 좌표를 받아오기 위한 fetch 요청
        fetch('/safety-direction/check', {
            method: 'post',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                query
            })
        }).then(async response => {
            console.log(response)
            if (response.ok) {
                const data = await response.json();
                const {lat, lng, accidentCoordinates} = data;
                // 지도의 중심을 사용자가 입력한 주소의 좌표로 이동
                map.setCenter({lat, lng});
                alert(`${query} 위치로 이동되었습니다.`);
                // 기존 마커 삭제
                markers.forEach(marker => marker.setMap(null));
                markers = [];

                // 사고 위치에 마커 생성
                accidentCoordinates.forEach(function(coordinate) {
                    const marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(coordinate.accidentLat, coordinate.accidentLng),
                        map: map
                    });
                    console.log(`마커 위치: 위도 ${marker.position.lat()}, 경도 ${marker.position.lng()}`);
                    markers.push(marker); // 생성된 마커를 배열에 추가
                });
            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>